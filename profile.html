<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Профиль</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.72);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --radius:22px;
    }

    *{
      box-sizing:border-box;
      font-family:'Inter',sans-serif;
      -webkit-tap-highlight-color:transparent;
    }

    html,body{
      height:100%;
      margin:0;
      overflow:hidden;
      color:var(--text);
      background:#020617;
    }

    body{
      background-image:url("https://i.postimg.cc/fbJT34yY/076E519D-F095-4957-88BF-5591DEB82533.png");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:
        radial-gradient(900px 600px at 30% 10%, rgba(42,171,238,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.42), rgba(0,0,0,.68));
      pointer-events:none;
      z-index:0;
    }

    .app{
      position:relative;
      height:100%;
      overflow:auto;
      padding: calc(18px + var(--safe-top)) 16px calc(28px + var(--safe-bottom)) 16px;
      z-index:1;
    }

    .wrap{
      max-width:520px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .icon-btn{
      width:44px;
      height:44px;
      border:none;
      border-radius:16px;
      cursor:pointer;
      display:grid;
      place-items:center;
      color:var(--text);
      background: rgba(8, 12, 22, .72);
      border: 1px solid rgba(46, 180, 255, .22);
      box-shadow:
        0 12px 34px rgba(0,0,0,.55),
        0 0 22px rgba(42,171,238,.14);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .icon-btn:active{ transform:scale(.98); }

    .top-title{
      flex:1;
      text-align:center;
      font-weight:900;
      font-size:18px;
      letter-spacing:.3px;
      color:rgba(234,241,255,.96);
    }

    .ghost{
      visibility:hidden;
    }

    .profile-card{
      margin-top:8px;
      border-radius:28px;
      padding:22px 18px 18px;
      background: rgba(8, 12, 22, .74);
      border: 1px solid rgba(46, 180, 255, .20);
      box-shadow:
        0 24px 70px rgba(0,0,0,.56),
        0 0 0 1px rgba(255,255,255,.04) inset,
        0 0 28px rgba(42,171,238,.14);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      position:relative;
      overflow:hidden;
    }

    .profile-card::before{
      content:"";
      position:absolute;
      inset:auto -60px 0 -60px;
      height:2px;
      background: linear-gradient(90deg, transparent, rgba(42,171,238,.95), rgba(59,130,246,.95), transparent);
      opacity:.7;
      pointer-events:none;
    }

    .profile-card::after{
      content:"";
      position:absolute;
      inset:-140px -160px auto auto;
      width:320px;
      height:320px;
      background: radial-gradient(circle at 30% 30%, rgba(42,171,238,.16), transparent 62%);
      pointer-events:none;
      transform: rotate(8deg);
    }

    .avatar-wrap{
      position:relative;
      z-index:1;
      width:118px;
      height:118px;
      margin:0 auto 16px;
      border-radius:50%;
      padding:4px;
      background: linear-gradient(180deg, rgba(42,171,238,.95), rgba(59,130,246,.55));
      box-shadow:
        0 16px 40px rgba(0,0,0,.45),
        0 0 26px rgba(42,171,238,.28);
    }

    .avatar{
      width:100%;
      height:100%;
      border-radius:50%;
      object-fit:cover;
      display:block;
      background:#0f172a;
    }

    .avatar-fallback{
      width:100%;
      height:100%;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:34px;
      color:#fff;
      background:
        radial-gradient(circle at 30% 30%, rgba(42,171,238,.95), rgba(59,130,246,.72)),
        linear-gradient(180deg, #0f172a, #111827);
    }

    .name{
      position:relative;
      z-index:1;
      text-align:center;
      font-size:20px;
      font-weight:900;
      letter-spacing:.2px;
      margin:0 0 4px 0;
      color:rgba(234,241,255,.98);
    }

    .username{
      position:relative;
      z-index:1;
      text-align:center;
      margin:0 0 18px 0;
      font-size:14px;
      font-weight:700;
      color:rgba(42,171,238,.96);
    }

    .info-list{
      position:relative;
      z-index:1;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .info-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      border-radius:18px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.05);
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
    }

    .info-label{
      font-size:13px;
      font-weight:800;
      color:var(--muted);
    }

    .info-value{
      font-size:14px;
      font-weight:900;
      color:rgba(234,241,255,.98);
      text-align:right;
      word-break:break-word;
    }

    .balance-box{
      margin-top:4px;
      border-radius:20px;
      padding:16px;
      background: linear-gradient(180deg, rgba(42,171,238,.14), rgba(59,130,246,.08));
      border:1px solid rgba(42,171,238,.20);
      box-shadow:
        0 14px 28px rgba(0,0,0,.28),
        0 0 18px rgba(42,171,238,.10);
    }

    .balance-label{
      font-size:13px;
      font-weight:800;
      color:var(--muted);
      margin-bottom:8px;
    }

    .balance-value{
      font-size:28px;
      line-height:1;
      font-weight:900;
      color:#fff;
      letter-spacing:.2px;
      text-shadow:0 12px 24px rgba(0,0,0,.28);
    }

    .status{
      margin-top:6px;
      text-align:center;
      font-size:12px;
      color:rgba(234,241,255,.62);
      min-height:16px;
    }

    @media (max-width:360px){
      .avatar-wrap{ width:108px; height:108px; }
      .balance-value{ font-size:24px; }
      .top-title{ font-size:17px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="wrap">

      <div class="topbar">
        <button class="icon-btn" id="backBtn" aria-label="Назад">←</button>
        <div class="top-title">Профиль</div>
        <div class="icon-btn ghost">←</div>
      </div>

      <div class="profile-card">
        <div class="avatar-wrap" id="avatarWrap">
          <div class="avatar-fallback" id="avatarFallback">?</div>
        </div>

        <h1 class="name" id="displayName">Загрузка...</h1>
        <p class="username" id="usernameValue">@username</p>

        <div class="info-list">
          <div class="info-item">
            <div class="info-label">Telegram ID</div>
            <div class="info-value" id="tgIdValue">—</div>
          </div>

          <div class="info-item">
            <div class="info-label">Ник Telegram</div>
            <div class="info-value" id="tgUsernameValue">—</div>
          </div>

          <div class="balance-box">
            <div class="balance-label">Баланс</div>
            <div class="balance-value" id="balanceValue">0 VC</div>
          </div>
        </div>

        <div class="status" id="statusText"></div>
      </div>

    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const VERIFY_URL = "https://lazrfierfbhwlduqlvws.functions.supabase.co/verify-telegram";

    const backBtn = document.getElementById('backBtn');
    const avatarWrap = document.getElementById('avatarWrap');
    const avatarFallback = document.getElementById('avatarFallback');
    const displayNameEl = document.getElementById('displayName');
    const usernameEl = document.getElementById('usernameValue');
    const tgIdEl = document.getElementById('tgIdValue');
    const tgUsernameEl = document.getElementById('tgUsernameValue');
    const balanceEl = document.getElementById('balanceValue');
    const statusEl = document.getElementById('statusText');

    function formatVc(value) {
      const num = Number(value ?? 0);
      if (!Number.isFinite(num)) return '0 VC';
      return Number.isInteger(num) ? `${num} VC` : `${num.toFixed(2)} VC`;
    }

    function getDisplayName(profile) {
      const full = [profile.first_name, profile.last_name].filter(Boolean).join(' ').trim();
      if (full) return full;
      if (profile.username) return '@' + profile.username;
      return 'Пользователь';
    }

    function getInitial(profile) {
      const source = (profile.first_name || profile.username || 'U').trim();
      return source.charAt(0).toUpperCase();
    }

    function setAvatar(profile) {
      avatarWrap.innerHTML = '';

      if (profile.photo_url) {
        const img = document.createElement('img');
        img.className = 'avatar';
        img.alt = 'Аватар';
        img.src = profile.photo_url;
        img.onerror = () => {
          avatarWrap.innerHTML = `<div class="avatar-fallback">${getInitial(profile)}</div>`;
        };
        avatarWrap.appendChild(img);
        return;
      }

      avatarWrap.innerHTML = `<div class="avatar-fallback">${getInitial(profile)}</div>`;
    }

    function renderProfile(profile) {
      if (!profile) return;

      localStorage.setItem('tg_profile', JSON.stringify(profile));

      setAvatar(profile);
      displayNameEl.textContent = getDisplayName(profile);
      usernameEl.textContent = profile.username ? `@${profile.username}` : 'Без ника';
      tgIdEl.textContent = profile.tg_id ?? '—';
      tgUsernameEl.textContent = profile.username ? `@${profile.username}` : '—';
      balanceEl.textContent = formatVc(profile.balance);
    }

    function loadCachedProfile() {
      try {
        const raw = localStorage.getItem('tg_profile');
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return null;
        return parsed;
      } catch {
        return null;
      }
    }

    async function refreshProfileFromTelegram() {
      if (!window.Telegram || !window.Telegram.WebApp) {
        statusEl.textContent = '';
        return;
      }

      try {
        Telegram.WebApp.ready();
        if (typeof Telegram.WebApp.expand === 'function') Telegram.WebApp.expand();
        if (typeof Telegram.WebApp.setHeaderColor === 'function') Telegram.WebApp.setHeaderColor('#020617');
      } catch (e) {}

      const initData = Telegram.WebApp.initData;
      if (!initData) return;

      statusEl.textContent = 'Обновляем профиль...';

      try {
        const res = await fetch(VERIFY_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ initData })
        });

        const json = await res.json().catch(() => ({}));

        if (!res.ok || !json.ok || !json.profile) {
          statusEl.textContent = '';
          return;
        }

        renderProfile(json.profile);
        statusEl.textContent = '';
      } catch (e) {
        statusEl.textContent = '';
      }
    }

    function initPage() {
      const cached = loadCachedProfile();

      if (cached) {
        renderProfile(cached);
      } else {
        displayNameEl.textContent = 'Профиль не найден';
        usernameEl.textContent = 'Сначала зайди через главную страницу';
        tgIdEl.textContent = '—';
        tgUsernameEl.textContent = '—';
        balanceEl.textContent = '0 VC';
      }

      refreshProfileFromTelegram();
    }

    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    window.addEventListener('load', initPage);
  </script>
</body>
</html>
