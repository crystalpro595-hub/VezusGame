<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Wallet</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />

<style>
*{
  box-sizing:border-box;
  font-family:'Inter',sans-serif;
  transition:all .3s;
  -webkit-tap-highlight-color:transparent;
  -webkit-text-size-adjust:100%;
}
body{
  margin:0;
  padding-top:60px;
  height:100vh;
  background:linear-gradient(180deg,#f8fafc,#eef2ff);
  color:#0f172a;
  overflow:hidden;
  touch-action:pan-x pan-y;
}
.screen{
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  display:flex;
  flex-direction:column;
  overflow-y:auto;
  padding-top:60px;
}
.hidden{display:none!important;}
.header{
  padding:18px;
  display:flex;
  align-items:center;
  gap:12px;
  justify-content:space-between;
}
.header h1{margin:0;font-size:20px;font-weight:900;}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ –±–∞–ª–∞–Ω—Å–∞ */
.wallet-card{
  margin:16px;
  padding:20px;
  border-radius:22px;
  background:linear-gradient(135deg,#60a5fa,#2563eb);
  color:#fff;
  box-shadow:0 20px 40px rgba(37,99,235,.35);
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  position:relative;
}
.wallet-info{flex:1;}
.wallet-label{font-size:13px;opacity:.9;margin-bottom:4px;}
.wallet-balance{font-size:34px;font-weight:900;line-height:1.2;}

/* –ö–Ω–æ–ø–∫–∞ –≤—ã–≤–æ–¥–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ */
.withdraw-in-card-btn{
  background:rgba(255,255,255,.2);
  border:1px solid rgba(255,255,255,.3);
  border-radius:14px;
  padding:10px 16px;
  color:#fff;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:all .2s;
  backdrop-filter:blur(10px);
  white-space:nowrap;
  margin-left:12px;
}
.withdraw-in-card-btn:hover{
  background:rgba(255,255,255,.3);
  transform:translateY(-2px);
  box-shadow:0 8px 16px rgba(0,0,0,.1);
}
.withdraw-in-card-btn:active{transform:translateY(0);}

.deposit{padding:0 16px;}
.deposit-title{font-size:15px;font-weight:800;margin:16px 0 10px;}

/* –ë–ª–æ–∫ –≤–≤–æ–¥–∞ —Å—É–º–º—ã */
.amount-container{margin-top:14px;position:relative;}
.amount-row{display:flex;gap:10px;margin-bottom:5px;}
.amount-row input{
  flex:1;
  padding:14px;
  border-radius:14px;
  border:1px solid #e2e8f0;
  background:#fff;
  font-size:16px;
  transition:border-color .3s, box-shadow .3s;
  -webkit-appearance:none;
  appearance:none;
}
.amount-row input:focus{
  border-color:#3b82f6;
  box-shadow:0 0 0 3px rgba(59,130,246,.2);
  outline:none;
}
.amount-row input.error{border-color:#dc2626;box-shadow:none;}
.amount-row .vc{
  min-width:90px;
  border-radius:14px;
  padding:14px;
  font-weight:900;
  text-align:center;
  background:#fff;
  border:1px solid #e2e8f0;
}

/* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –º–∏–Ω–∏–º—É–º–∞ */
.minimum-hint{
  font-size:13px;
  color:#94a3b8;
  margin-top:2px;
  margin-left:2px;
  min-height:16px;
  display:block;
  transition:color .3s;
}
.minimum-hint.error{color:#dc2626!important;}

.sender-name{
  margin-top:12px;
  opacity:0;
  max-height:0;
  overflow:hidden;
  transition:opacity .4s ease, max-height .4s ease;
}
.sender-name.show{opacity:1;max-height:120px;}
.sender-name input{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #e2e8f0;
  font-size:16px;
  background:#fff;
  box-sizing:border-box;
  transition:border-color .3s, box-shadow .3s;
}
.sender-name input:focus{
  border-color:#3b82f6;
  box-shadow:0 0 0 3px rgba(59,130,246,.2);
  outline:none;
}
.sender-name input.error{border-color:#dc2626;box-shadow:none;}
.sender-error{font-size:13px;color:#dc2626;margin-top:4px;display:none;}
.sender-error.show{display:block;}

/* –ö–Ω–æ–ø–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è */
.pay{
  margin:22px 16px 6px;
  padding:18px;
  border-radius:18px;
  border:none;
  background:linear-gradient(135deg,#3b82f6,#2563eb);
  color:#fff;
  font-size:17px;
  font-weight:900;
  box-shadow:0 15px 30px rgba(37,99,235,.35);
  transition:.3s;
  cursor:pointer;
  opacity:.6;
}
.pay.active{opacity:1;}
.pay:hover{box-shadow:0 20px 40px rgba(37,99,235,.45);}
.pay:active{transform:scale(.97);}

/* –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" */
.back-gradient-btn{
  margin:10px auto 22px;
  padding:18px;
  border-radius:18px;
  border:none;
  background:linear-gradient(135deg,#60a5fa,#2563eb);
  color:#fff;
  font-size:17px;
  font-weight:900;
  box-shadow:0 15px 30px rgba(37,99,235,.35);
  cursor:pointer;
  width:min(400px, calc(100% - 32px));
  display:block;
  transition:.3s;
}
.back-gradient-btn:hover{
  box-shadow:0 20px 40px rgba(37,99,235,.45);
  transform:translateY(-2px);
}
.back-gradient-btn:active{ transform:scale(.97); }

/* –ö–Ω–æ–ø–∫–∞ –≤—ã–≤–æ–¥–∞ */
.withdraw-button{
  margin:30px auto 12px;
  padding:20px;
  border-radius:18px;
  border:none;
  background:linear-gradient(135deg,#3b82f6,#2563eb);
  color:#fff;
  font-size:18px;
  font-weight:900;
  box-shadow:0 15px 30px rgba(37,99,235,.35);
  transition:all .3s;
  cursor:pointer;
  opacity:.6;
  width:min(400px, calc(100% - 32px));
  display:block;
}
.withdraw-button.active{opacity:1;}
.withdraw-button:hover{
  box-shadow:0 20px 40px rgba(37,99,235,.45);
  transform:translateY(-2px);
}
.withdraw-button:active{transform:scale(.97);}

.withdraw-button:disabled,
.pay:disabled{
  opacity:.6!important;
  cursor:not-allowed!important;
  background:#94a3b8!important;
  box-shadow:none!important;
  transform:none!important;
}
.withdraw-button:disabled:hover,
.pay:disabled:hover{
  transform:none!important;
  box-shadow:none!important;
}

.quick-amounts{display:flex;justify-content:space-between;margin-top:14px;gap:6px;}
.quick-amounts .amount-btn{
  flex:1;
  padding:12px 8px;
  border-radius:12px;
  border:2px solid #e2e8f0;
  background:#fff;
  font-size:15px;
  font-weight:800;
  color:#334155;
  cursor:pointer;
  transition:all .2s;
  text-align:center;
  position:relative;
  overflow:hidden;
}
.quick-amounts .amount-btn:hover{
  border-color:#3b82f6;
  background:#f0f7ff;
  transform:translateY(-2px);
}
.quick-amounts .amount-btn:active{transform:translateY(0);}
.quick-amounts .amount-btn::after{
  content:'';
  position:absolute;
  top:0;left:0;right:0;
  height:2px;
  background:linear-gradient(135deg,#3b82f6,#2563eb);
  opacity:0;
  transition:opacity .3s;
}
.quick-amounts .amount-btn:hover::after{opacity:1;}

/* –ü–æ–ø–∞–ø—ã */
.popup-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.5);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10000;
  opacity:0;
  pointer-events:none;
  transition:opacity .3s ease;
}
.popup-overlay.show{opacity:1;pointer-events:auto;}
.popup{
  background:#fff;
  border-radius:22px;
  padding:20px 24px;
  max-width:560px;
  width:98%;
  text-align:center;
  box-shadow:0 20px 40px rgba(0,0,0,.15);
  position:relative;
  transform:scale(.8);
  opacity:0;
  transition:transform .3s ease, opacity .3s ease;
}
.popup-overlay.show .popup{transform:scale(1);opacity:1;}
.popup .close-btn{position:absolute;top:12px;right:12px;font-size:20px;cursor:pointer;}
.popup .popup-content{display:flex;flex-direction:column;gap:16px;margin-top:16px;}
.popup-amount{font-size:20px;font-weight:800;text-align:left;}
.popup-bank-info{
  display:flex;
  align-items:center;
  gap:12px;
  background:#f8fafc;
  border-radius:16px;
  padding:14px 18px;
  margin-bottom:8px;
}
.popup-bank-logo{
  width:40px;height:40px;
  background:linear-gradient(135deg,#2ac46d,#1a9e57);
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-weight:900;
  font-size:18px;
}
.popup-bank-text{flex:1;text-align:left;}
.popup-bank-title{font-weight:800;font-size:16px;color:#0f172a;}
.popup-bank-subtitle{font-size:14px;color:#64748b;}
.payment-methods{display:flex;gap:12px;margin-bottom:8px;}
.payment-method-btn{
  flex:1;
  padding:16px;
  border-radius:16px;
  border:1px solid #e2e8f0;
  background:#f8fafc;
  font-size:16px;
  font-weight:600;
  color:#334155;
  cursor:pointer;
  transition:.2s;
}
.payment-method-btn:hover{background:#e0f2fe;}
.payment-method-btn.active{background:#3b82f6;color:#fff;border-color:#2563eb;}
.payment-method-btn .icon{font-size:20px;margin-bottom:8px;display:block;}

.transfer-container{display:flex;flex-direction:column;}
.transfer-wrapper{position:relative;min-height:70px;margin-bottom:2px;}
.transfer{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:14px 16px;
  border-radius:18px;
  background:#fff;
  border:1px solid #e2e8f0;
  box-shadow:0 4px 12px rgba(0,0,0,.05);
  font-weight:600;
  font-size:14px;
  word-break:break-all;
  position:absolute;
  top:0;left:0;right:0;
  opacity:0;
  transform:translateY(10px);
  transition:opacity .3s, transform .3s;
}
.transfer.show{opacity:1;transform:translateY(0);}
.transfer button.copy{
  border:none;
  background:#f1f5f9;
  border-radius:50%;
  padding:10px;
  width:40px;height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
  color:#0f172a;
  box-shadow:0 4px 8px rgba(0,0,0,.08);
  cursor:pointer;
  transition:.2s;
}
.transfer button.copy:hover{
  box-shadow:0 6px 14px rgba(37,99,235,.25);
  background:#e0f2fe;
}
.transfer-loader{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:20px;
  min-height:70px;
  opacity:1;
  transition:opacity .3s;
}
.transfer-loader.hidden{opacity:0;pointer-events:none;}
.loader-small{
  border:4px solid #f1f1f1;
  border-top:4px solid #2563eb;
  border-radius:50%;
  width:32px;height:32px;
  animation:spin 1s linear infinite;
  margin-bottom:12px;
}
.recipient-info-wrapper{
  opacity:0;
  transform:translateY(10px);
  transition:opacity .3s, transform .3s;
  margin-top:6px;
}
.recipient-info-wrapper.show{opacity:1;transform:translateY(0);}
.recipient-info{
  display:flex;
  flex-direction:column;
  gap:2px;
  background:#f8fafc;
  border-radius:12px;
  padding:8px 14px;
}
.recipient-info-item{display:flex;justify-content:space-between;font-size:12px;line-height:1.2;}
.recipient-info-label{color:#64748b;}
.recipient-info-value{font-weight:600;color:#0f172a;}

.instruction-title{
  cursor:pointer;
  background:#f1f5f9;
  border-radius:14px;
  padding:12px;
  text-align:left;
  font-weight:600;
  color:#334155;
  margin-top:8px;
}
.instruction-content{
  margin-top:8px;
  padding:12px;
  background:#f8fafc;
  border-radius:14px;
  font-size:14px;
  color:#334155;
  display:none;
  text-align:left;
}
.warning{
  font-size:12px;
  color:#92400e;
  background:#fef3c7;
  border-radius:14px;
  padding:10px;
  text-align:center;
  margin-top:4px;
}

/* –ó–∞–≥—Ä—É–∑–∫–∞ */
.loader,
.withdraw-loader{
  border:6px solid #f1f1f1;
  border-top:6px solid #2563eb;
  border-radius:50%;
  width:48px;height:48px;
  margin:16px auto;
  animation:spin 1s linear infinite;
}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

.toast{
  position:fixed;
  bottom:30px;
  left:50%;
  transform:translateX(-50%) translateY(100px);
  background:#10b981;
  color:#fff;
  padding:12px 24px;
  border-radius:14px;
  font-weight:700;
  opacity:0;
  pointer-events:none;
  transition:opacity .3s, transform .5s cubic-bezier(0.68,-0.55,0.265,1.55);
  z-index:10001;
  box-shadow:0 10px 25px rgba(16,185,129,.3);
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* –ü–æ–ª—è –≤—ã–≤–æ–¥–∞ */
.withdraw-fields{
  opacity:0;
  max-height:0;
  overflow:hidden;
  transition:all .5s;
  margin-top:12px;
}
.withdraw-fields.show{opacity:1;max-height:500px;}

.withdraw-grid{
  display:grid;
  grid-template-columns:1fr;
  gap:12px;
  margin-top:16px;
}
@media (min-width:480px){
  .withdraw-grid{grid-template-columns:repeat(3,1fr);}
}
.withdraw-field{display:flex;flex-direction:column;}
.withdraw-field input{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #e2e8f0;
  font-size:16px;
  background:#fff;
  transition:border-color .3s, box-shadow .3s;
  box-sizing:border-box;
  -webkit-appearance:none;
  appearance:none;
}
.withdraw-field input:focus{
  border-color:#3b82f6;
  box-shadow:0 0 0 3px rgba(59,130,246,.2);
  outline:none;
}
.withdraw-field input.error{border-color:#dc2626;box-shadow:none;}
.withdraw-field-error{
  font-size:13px;
  color:#dc2626;
  margin-top:4px;
  display:none;
  min-height:20px;
}
.withdraw-field-error.show{display:block;}

/* Android fix */
.android-fix{
  -webkit-user-select:none;
  -moz-user-select:none;
  -ms-user-select:none;
  user-select:none;
  -webkit-tap-highlight-color:rgba(0,0,0,0);
}
</style>
</head>

<body class="android-fix">

<div class="screen" id="mainScreen">
  <div class="header">
    <span></span>
    <h1>–ö–æ—à–µ–ª—ë–∫</h1>
    <span></span>
  </div>

  <div class="wallet-card">
    <div class="wallet-info">
      <div class="wallet-label">–ë–∞–ª–∞–Ω—Å</div>
      <div class="wallet-balance" id="walletBalance">0 VC</div>
    </div>
    <button class="withdraw-in-card-btn" onclick="openWithdrawScreen()">–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</button>
  </div>

  <div class="deposit">
    <div class="deposit-title">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>

    <div class="amount-container">
      <div class="amount-row">
        <input id="amountInput" type="number" placeholder="–°—É–º–º–∞ ‚ÇΩ" oninput="validateForm()" onchange="validateForm()">
        <div class="vc" id="vcDisplay">0 VC</div>
      </div>
      <div class="minimum-hint" id="minimumHint">–ú–∏–Ω–∏–º—É–º 100‚ÇΩ</div>
    </div>

    <div class="sender-name" id="senderNameContainer">
      <input type="text" id="senderName" placeholder="–§–ò–û –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è" oninput="validateForm()" onchange="validateForm()">
      <div class="sender-error" id="senderError">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
    </div>

    <div class="quick-amounts" id="quickAmounts">
      <button class="amount-btn" onclick="setAmount(100)">100‚ÇΩ</button>
      <button class="amount-btn" onclick="setAmount(500)">500‚ÇΩ</button>
      <button class="amount-btn" onclick="setAmount(1000)">1000‚ÇΩ</button>
      <button class="amount-btn" onclick="setAmount(2500)">2500‚ÇΩ</button>
    </div>
  </div>

  <button class="pay" id="payButton" onclick="openPaymentPopup()" disabled>–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
  <button class="back-gradient-btn" type="button" onclick="goToIndex()">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</button>
</div>

<div class="screen hidden" id="withdrawScreen">
  <div class="header">
    <span></span>
    <h1>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h1>
    <span></span>
  </div>

  <div class="wallet-card">
    <div class="wallet-info">
      <div class="wallet-label">–ë–∞–ª–∞–Ω—Å</div>
      <div class="wallet-balance" id="withdrawBalance">0 VC</div>
    </div>
    <div style="width:100px;"></div>
  </div>

  <div class="deposit">
    <div class="deposit-title">–°—É–º–º–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞</div>

    <div class="amount-container">
      <div class="amount-row">
        <input id="withdrawAmount" type="number" placeholder="–°—É–º–º–∞ VC" oninput="validateWithdraw()" onchange="validateWithdraw()" style="width:100%;">
      </div>
      <div class="minimum-hint" id="withdrawMinimumHint">–ú–∏–Ω–∏–º—É–º 1000 VC</div>
    </div>

    <div class="withdraw-fields" id="withdrawFields">
      <div class="withdraw-grid">
        <div class="withdraw-field">
          <input type="text" id="requisitesInput" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã/—Å—á—ë—Ç–∞" oninput="validateWithdraw()" onchange="validateWithdraw()">
          <div class="withdraw-field-error" id="requisitesError">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
        </div>

        <div class="withdraw-field">
          <input type="text" id="fioInput" placeholder="–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è" oninput="validateWithdraw()" onchange="validateWithdraw()">
          <div class="withdraw-field-error" id="fioWithdrawError">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
        </div>

        <div class="withdraw-field">
          <input type="text" id="bankInput" placeholder="–ë–∞–Ω–∫" oninput="validateWithdraw()" onchange="validateWithdraw()">
          <div class="withdraw-field-error" id="bankWithdrawError">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
        </div>
      </div>
    </div>

    <button class="withdraw-button" id="withdrawButton" onclick="processWithdraw()" disabled>–í—ã–≤–µ—Å—Ç–∏</button>
    <button class="back-gradient-btn" type="button" onclick="backToMain()">–ù–∞–∑–∞–¥</button>
  </div>
</div>

<div class="popup-overlay" id="paymentPopup">
  <div class="popup">
    <span class="close-btn" onclick="closePaymentPopup()">√ó</span>
    <div class="popup-content">
      <div class="popup-amount" id="popupAmount">–°—É–º–º–∞: 0 ‚ÇΩ</div>

      <div class="popup-bank-info">
        <div class="popup-bank-logo">S</div>
        <div class="popup-bank-text">
          <div class="popup-bank-title">–í—ã–±—Ä–∞–Ω–Ω—ã–π –±–∞–Ω–∫: –°–±–µ—Ä–ë–∞–Ω–∫</div>
          <div class="popup-bank-subtitle">–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –°–±–µ—Ä–ë–∞–Ω–∫</div>
        </div>
      </div>

      <div class="payment-methods">
        <button class="payment-method-btn active" id="phoneMethod" onclick="selectPaymentMethod('phone')">
          <span class="icon">üì±</span> –ü–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        </button>
        <button class="payment-method-btn" id="cardMethod" onclick="selectPaymentMethod('card')">
          <span class="icon">üí≥</span> –ü–æ –Ω–æ–º–µ—Ä—É –∫–∞—Ä—Ç—ã
        </button>
      </div>

      <div class="transfer-container">
        <div class="transfer-wrapper">
          <div class="transfer-loader" id="transferLoader">
            <div class="loader-small"></div>
            <p>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤...</p>
          </div>

          <div class="transfer" id="phoneTransfer">
            <span>+7 (990) 778-56-56</span>
            <button class="copy" onclick="copyDetails('+79907785656')">üìã</button>
          </div>

          <div class="transfer" id="cardTransfer">
            <span>2200 9099 0000 0000</span>
            <button class="copy" onclick="copyDetails('2200909900000000')">üìã</button>
          </div>
        </div>

        <div class="recipient-info-wrapper" id="recipientInfoWrapper">
          <div class="recipient-info">
            <div class="recipient-info-item">
              <span class="recipient-info-label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
              <span class="recipient-info-value">–ê–Ω–¥—Ä–µ–π –ê.–õ</span>
            </div>
            <div class="recipient-info-item">
              <span class="recipient-info-label">–ë–∞–Ω–∫:</span>
              <span class="recipient-info-value">–°–±–µ—Ä–±–∞–Ω–∫</span>
            </div>
          </div>
        </div>
      </div>

      <div class="instruction-title" onclick="toggleInstruction()">–ö–∞–∫ –ø–æ–ø–æ–ª–Ω–∏—Ç—å?</div>
      <div class="instruction-content" id="instructionContent">
        1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã<br>
        2. –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–∞–Ω–∫–∞<br>
        3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É –Ω–∞ –°–±–µ—Ä–ë–∞–Ω–∫<br>
        4. –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–µ–ø–æ–∑–∏—Ç–∞<br>
        5. –ù–∞–∂–∞—Ç—å ¬´–Ø –æ–ø–ª–∞—Ç–∏–ª¬ª
      </div>

      <button class="pay active" style="margin-top:16px;" onclick="openCheckPopup()">–Ø –æ–ø–ª–∞—Ç–∏–ª</button>
      <div class="warning">‚ö†Ô∏è –ü–µ—Ä–µ–≤–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω –Ω–∞ –∫–∞—Ä—Ç—É –°–±–µ—Ä–±–∞–Ω–∫–∞</div>
    </div>
  </div>
</div>

<div class="popup-overlay" id="depositCheckPopup">
  <div class="popup">
    <div class="popup-content">
      <div class="loader"></div>
      <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–∞‚Ä¶<br>–°–æ–∑–¥–∞—ë–º –∑–∞—è–≤–∫—É</p>
    </div>
  </div>
</div>

<div class="popup-overlay" id="withdrawProcessingPopup">
  <div class="popup">
    <div class="popup-content">
      <div class="withdraw-loader"></div>
      <p>–°–æ–∑–¥–∞—ë–º –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥‚Ä¶</p>
    </div>
  </div>
</div>

<div class="toast" id="toast">–ì–æ—Ç–æ–≤–æ</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
const VERIFY_URL = "https://lazrfierfbhwlduqlvws.functions.supabase.co/verify-telegram";
const CREATE_DEPOSIT_URL = "https://lazrfierfbhwlduqlvws.functions.supabase.co/create-deposit-request";
const CREATE_WITHDRAW_URL = "https://lazrfierfbhwlduqlvws.functions.supabase.co/create-withdraw-request";

let activePaymentMethod = 'phone';
let isWithdrawProcessing = false;
let isAndroid = /Android/i.test(navigator.userAgent);

let depositTouched = false;
let withdrawTouched = false;

let paymentLoaderTimer = null;
let depositCheckTimer = null;
let withdrawTimer = null;

let telegramProfile = null;
let currentBalance = 0;

function $(id){ return document.getElementById(id); }

function closeAllPopups(){
  $('paymentPopup').classList.remove('show');
  $('depositCheckPopup').classList.remove('show');
  $('withdrawProcessingPopup').classList.remove('show');
}

function detectDevice(){
  const userAgent = navigator.userAgent || navigator.vendor || window.opera;
  isAndroid = /android/i.test(userAgent);
}

function formatVc(value){
  const num = Number(value ?? 0);
  if (!Number.isFinite(num)) return '0 VC';
  return Number.isInteger(num) ? `${num} VC` : `${num.toFixed(2)} VC`;
}

function setBalanceUI(value){
  const num = Number(value ?? 0);
  currentBalance = Number.isFinite(num) ? num : 0;
  const text = formatVc(currentBalance);
  $('walletBalance').textContent = text;
  $('withdrawBalance').textContent = text;
}

function loadCachedProfile(){
  try{
    const raw = localStorage.getItem('tg_profile');
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed !== 'object') return null;
    return parsed;
  } catch {
    return null;
  }
}

function applyProfile(profile){
  if (!profile) return;
  telegramProfile = profile;
  localStorage.setItem('tg_profile', JSON.stringify(profile));
  setBalanceUI(profile.balance);
}

function getTelegramInitData(){
  if (!window.Telegram || !window.Telegram.WebApp) {
    throw new Error('–û—Ç–∫—Ä–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–Ω—É—Ç—Ä–∏ Telegram Mini App');
  }

  try{
    Telegram.WebApp.ready();
    if (typeof Telegram.WebApp.expand === 'function') Telegram.WebApp.expand();
  } catch(e){}

  const initData = Telegram.WebApp.initData;
  if (!initData) {
    throw new Error('–ù–µ—Ç initData');
  }

  return initData;
}

async function postJson(url, payload){
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const json = await res.json().catch(() => ({}));

  if (!res.ok || !json.ok) {
    const message = json.error || json.details || `–û—à–∏–±–∫–∞ ${res.status}`;
    const err = new Error(message);
    err.payload = json;
    throw err;
  }

  return json;
}

async function refreshWalletProfile(){
  const cached = loadCachedProfile();

  if (cached) applyProfile(cached);
  else setBalanceUI(0);

  try{
    const initData = getTelegramInitData();
    const json = await postJson(VERIFY_URL, { initData });

    if (json.profile) {
      applyProfile(json.profile);
    }
  } catch(err){
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', err);
  }
}

function resetDepositForm(){
  $('amountInput').value = '';
  $('senderName').value = '';
  $('vcDisplay').textContent = '0 VC';
  $('popupAmount').textContent = '–°—É–º–º–∞: 0 ‚ÇΩ';
  $('senderNameContainer').classList.remove('show');
  $('senderName').classList.remove('error');
  $('senderError').classList.remove('show');
  $('amountInput').classList.remove('error');
  $('minimumHint').classList.remove('error');
  $('minimumHint').textContent = '–ú–∏–Ω–∏–º—É–º 100‚ÇΩ';
  depositTouched = false;
  updatePayButton(false);
}

function resetWithdrawForm(){
  $('withdrawAmount').value = '';
  $('requisitesInput').value = '';
  $('fioInput').value = '';
  $('bankInput').value = '';

  $('withdrawAmount').classList.remove('error');
  $('withdrawMinimumHint').classList.remove('error');
  $('withdrawMinimumHint').textContent = '–ú–∏–Ω–∏–º—É–º 1000 VC';
  $('withdrawFields').classList.remove('show');

  $('requisitesInput').classList.remove('error');
  $('requisitesError').classList.remove('show');
  $('fioInput').classList.remove('error');
  $('fioWithdrawError').classList.remove('show');
  $('bankInput').classList.remove('error');
  $('bankWithdrawError').classList.remove('show');

  withdrawTouched = false;
  updateWithdrawButton(false);
}

function goToIndex(){
  closeAllPopups();
  window.location.href = 'index.html';
}

function showToast(text, color){
  const toast = $('toast');
  toast.textContent = text || "–ì–æ—Ç–æ–≤–æ";
  toast.style.background = color || '#10b981';
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2200);
}

function copyDetails(text){
  if (navigator.clipboard && window.isSecureContext){
    navigator.clipboard.writeText(text).then(() => showToast("–†–µ–∫–≤–∏–∑–∏—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!"))
      .catch(() => fallbackCopyText(text));
  } else fallbackCopyText(text);
}

function fallbackCopyText(text){
  const ta = document.createElement("textarea");
  ta.value = text;
  ta.style.position = "fixed";
  ta.style.left = "-999999px";
  ta.style.top = "-999999px";
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try { document.execCommand('copy'); showToast("–†–µ–∫–≤–∏–∑–∏—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!"); } catch(e){}
  ta.remove();
}

function toggleInstruction(){
  const content = $('instructionContent');
  content.style.display = (content.style.display === 'block') ? 'none' : 'block';
}

function setAmount(value){
  depositTouched = true;
  const amountInput = $('amountInput');
  amountInput.value = value;

  if (isAndroid){
    amountInput.dispatchEvent(new Event('input',{bubbles:true}));
    amountInput.dispatchEvent(new Event('change',{bubbles:true}));
  }

  validateForm();
}

function updatePayButton(isActive){
  const btn = $('payButton');
  if (isActive){
    btn.classList.add('active');
    btn.disabled = false;
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';
  } else {
    btn.classList.remove('active');
    btn.disabled = true;
    btn.style.opacity = '0.6';
    btn.style.cursor = 'not-allowed';
  }
}

function validateForm(){
  const amountEl = $('amountInput');
  const raw = amountEl.value;
  const amount = Number(raw);

  const hasValue = raw !== '' && !Number.isNaN(amount);

  const fioEl = $('senderName');
  const fio = fioEl.value.trim();

  const senderContainer = $('senderNameContainer');
  const senderError = $('senderError');
  const minHint = $('minimumHint');

  const vcVal = hasValue ? amount : 0;
  $('vcDisplay').textContent = `${vcVal} VC`;
  $('popupAmount').textContent = `–°—É–º–º–∞: ${vcVal} ‚ÇΩ`;

  if (!hasValue){
    amountEl.classList.remove('error');
    minHint.classList.remove('error');
    senderContainer.classList.remove('show');
    fioEl.classList.remove('error');
    senderError.classList.remove('show');
    updatePayButton(false);
    return;
  }

  if (amount >= 100){
    amountEl.classList.remove('error');
    minHint.classList.remove('error');
    senderContainer.classList.add('show');

    if (fio.length === 0){
      fioEl.classList.add('error');
      senderError.classList.add('show');
      updatePayButton(false);
    } else {
      fioEl.classList.remove('error');
      senderError.classList.remove('show');
      updatePayButton(true);
    }
  } else {
    if (depositTouched){
      amountEl.classList.add('error');
      minHint.classList.add('error');
    } else {
      amountEl.classList.remove('error');
      minHint.classList.remove('error');
    }

    senderContainer.classList.remove('show');
    fioEl.classList.remove('error');
    senderError.classList.remove('show');
    updatePayButton(false);
  }
}

function openPaymentPopup(){
  const btn = $('payButton');
  if (btn.disabled) return;

  activePaymentMethod = 'phone';
  $('phoneMethod').classList.add('active');
  $('cardMethod').classList.remove('active');

  $('phoneTransfer').classList.remove('show');
  $('cardTransfer').classList.remove('show');
  $('recipientInfoWrapper').classList.remove('show');
  $('transferLoader').classList.remove('hidden');

  closeAllPopups();
  $('paymentPopup').classList.add('show');

  if (paymentLoaderTimer) clearTimeout(paymentLoaderTimer);
  paymentLoaderTimer = setTimeout(() => {
    $('transferLoader').classList.add('hidden');
    $('phoneTransfer').classList.add('show');
    $('recipientInfoWrapper').classList.add('show');
  }, 1000);
}

function closePaymentPopup(){
  $('paymentPopup').classList.remove('show');
  if (paymentLoaderTimer) clearTimeout(paymentLoaderTimer);
}

function selectPaymentMethod(method){
  activePaymentMethod = method;

  const phoneTransfer = $('phoneTransfer');
  const cardTransfer  = $('cardTransfer');

  $('transferLoader').classList.remove('hidden');
  phoneTransfer.classList.remove('show');
  cardTransfer.classList.remove('show');
  $('recipientInfoWrapper').classList.remove('show');

  if (method === 'phone'){
    $('phoneMethod').classList.add('active');
    $('cardMethod').classList.remove('active');
  } else {
    $('phoneMethod').classList.remove('active');
    $('cardMethod').classList.add('active');
  }

  if (paymentLoaderTimer) clearTimeout(paymentLoaderTimer);
  paymentLoaderTimer = setTimeout(() => {
    $('transferLoader').classList.add('hidden');
    (method === 'phone' ? phoneTransfer : cardTransfer).classList.add('show');
    $('recipientInfoWrapper').classList.add('show');
  }, 1000);
}

async function openCheckPopup(){
  const btn = $('payButton');
  if (btn.disabled) return;

  const amount = Number($('amountInput').value);
  const senderName = $('senderName').value.trim();

  if (!amount || amount < 100 || !senderName) {
    validateForm();
    return;
  }

  closePaymentPopup();
  closeAllPopups();
  $('depositCheckPopup').classList.add('show');

  try{
    const initData = getTelegramInitData();

    const json = await postJson(CREATE_DEPOSIT_URL, {
      initData,
      amountRub: amount,
      senderName,
      paymentMethod: activePaymentMethod
    });

    if (depositCheckTimer) clearTimeout(depositCheckTimer);
    depositCheckTimer = setTimeout(() => {
      $('depositCheckPopup').classList.remove('show');
      showToast(`–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ${amount}‚ÇΩ —Å–æ–∑–¥–∞–Ω–∞`, '#3b82f6');
      resetDepositForm();
    }, 1200);

    console.log('Deposit request created:', json.request);
  } catch(err){
    $('depositCheckPopup').classList.remove('show');
    showToast(err.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏', '#ef4444');
    console.error('Deposit request error:', err);
  }
}

function openWithdrawScreen(){
  closeAllPopups();
  isWithdrawProcessing = false;

  $('mainScreen').classList.add('hidden');
  $('withdrawScreen').classList.remove('hidden');

  setBalanceUI(currentBalance);
  resetWithdrawForm();
}

function backToMain(){
  closeAllPopups();
  $('withdrawScreen').classList.add('hidden');
  $('mainScreen').classList.remove('hidden');
}

function updateWithdrawButton(isActive){
  const btn = $('withdrawButton');
  if (isActive){
    btn.classList.add('active');
    btn.disabled = false;
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';
  } else {
    btn.classList.remove('active');
    btn.disabled = true;
    btn.style.opacity = '0.6';
    btn.style.cursor = 'not-allowed';
  }
}

function validateWithdraw(){
  withdrawTouched = true;

  const amountEl = $('withdrawAmount');
  const raw = amountEl.value;
  const amount = Number(raw);
  const hasValue = raw !== '' && !Number.isNaN(amount);

  const minHint = $('withdrawMinimumHint');
  const fields  = $('withdrawFields');

  const reqEl  = $('requisitesInput');
  const fioEl  = $('fioInput');
  const bankEl = $('bankInput');

  const reqErr  = $('requisitesError');
  const fioErr  = $('fioWithdrawError');
  const bankErr = $('bankWithdrawError');

  if (!hasValue){
    amountEl.classList.remove('error');
    minHint.classList.remove('error');
    minHint.textContent = '–ú–∏–Ω–∏–º—É–º 1000 VC';
    fields.classList.remove('show');

    reqEl.classList.remove('error');  reqErr.classList.remove('show');
    fioEl.classList.remove('error');  fioErr.classList.remove('show');
    bankEl.classList.remove('error'); bankErr.classList.remove('show');

    updateWithdrawButton(false);
    return;
  }

  if (amount < 1000){
    amountEl.classList.add('error');
    minHint.classList.add('error');
    minHint.textContent = '–ú–∏–Ω–∏–º—É–º 1000 VC';
    fields.classList.remove('show');

    reqEl.classList.remove('error');  reqErr.classList.remove('show');
    fioEl.classList.remove('error');  fioErr.classList.remove('show');
    bankEl.classList.remove('error'); bankErr.classList.remove('show');

    updateWithdrawButton(false);
    return;
  }

  if (amount > currentBalance){
    amountEl.classList.add('error');
    minHint.classList.add('error');
    minHint.textContent = `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ ¬∑ –î–æ—Å—Ç—É–ø–Ω–æ ${formatVc(currentBalance)}`;
    fields.classList.remove('show');

    reqEl.classList.remove('error');  reqErr.classList.remove('show');
    fioEl.classList.remove('error');  fioErr.classList.remove('show');
    bankEl.classList.remove('error'); bankErr.classList.remove('show');

    updateWithdrawButton(false);
    return;
  }

  amountEl.classList.remove('error');
  minHint.classList.remove('error');
  minHint.textContent = `–î–æ—Å—Ç—É–ø–Ω–æ ${formatVc(currentBalance)}`;
  fields.classList.add('show');

  const isReq  = reqEl.value.trim().length > 0;
  const isFio  = fioEl.value.trim().length > 0;
  const isBank = bankEl.value.trim().length > 0;

  if (!isReq){ reqEl.classList.add('error'); reqErr.classList.add('show'); }
  else { reqEl.classList.remove('error'); reqErr.classList.remove('show'); }

  if (!isFio){ fioEl.classList.add('error'); fioErr.classList.add('show'); }
  else { fioEl.classList.remove('error'); fioErr.classList.remove('show'); }

  if (!isBank){ bankEl.classList.add('error'); bankErr.classList.add('show'); }
  else { bankEl.classList.remove('error'); bankErr.classList.remove('show'); }

  const allOk = isReq && isFio && isBank;
  updateWithdrawButton(allOk && !isWithdrawProcessing);
}

async function processWithdraw(){
  const btn = $('withdrawButton');
  if (btn.disabled) return;
  if (isWithdrawProcessing) return;

  const amount = Number($('withdrawAmount').value);
  const requisites = $('requisitesInput').value.trim();
  const fio = $('fioInput').value.trim();
  const bank = $('bankInput').value.trim();

  if (!amount || amount < 1000 || amount > currentBalance || !requisites || !fio || !bank){
    validateWithdraw();
    return;
  }

  isWithdrawProcessing = true;
  updateWithdrawButton(false);

  closeAllPopups();
  $('withdrawProcessingPopup').classList.add('show');

  try{
    const initData = getTelegramInitData();

    const json = await postJson(CREATE_WITHDRAW_URL, {
      initData,
      amountVc: amount,
      requisites,
      bankName: bank,
      recipientFio: fio
    });

    if (withdrawTimer) clearTimeout(withdrawTimer);
    withdrawTimer = setTimeout(() => {
      $('withdrawProcessingPopup').classList.remove('show');

      if (typeof json.current_balance !== 'undefined') {
        setBalanceUI(json.current_balance);
        const cached = loadCachedProfile() || {};
        cached.balance = json.current_balance;
        localStorage.setItem('tg_profile', JSON.stringify(cached));
      }

      showToast(`–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ ${amount} VC —Å–æ–∑–¥–∞–Ω–∞`, '#3b82f6');

      isWithdrawProcessing = false;
      backToMain();
      resetWithdrawForm();
    }, 1200);

    console.log('Withdraw request created:', json.request);
  } catch(err){
    $('withdrawProcessingPopup').classList.remove('show');
    isWithdrawProcessing = false;
    validateWithdraw();
    showToast(err.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏', '#ef4444');
    console.error('Withdraw request error:', err);
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  detectDevice();

  closeAllPopups();
  updatePayButton(false);
  updateWithdrawButton(false);

  $('minimumHint').classList.remove('error');
  $('withdrawMinimumHint').classList.remove('error');

  setBalanceUI(0);
  await refreshWalletProfile();
});

document.addEventListener('touchstart', (event) => {
  if (event.touches.length > 1) event.preventDefault();
}, { passive:false });

let lastTouchEnd = 0;
document.addEventListener('touchend', (event) => {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) event.preventDefault();
  lastTouchEnd = now;
}, false);

document.addEventListener('gesturestart', (e) => e.preventDefault());

$('amountInput')?.addEventListener('input', () => { depositTouched = true; });
$('withdrawAmount')?.addEventListener('input', () => { withdrawTouched = true; });
</script>

</body>
</html>
